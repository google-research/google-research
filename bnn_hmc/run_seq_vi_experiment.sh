#!/bin/bash

arg="cifar100"

if [[ "$arg" == "cifar10" ]]; then
    DATASET="cifar10"
    MODEL="resnet20_frn_swish"
    SGD_WEIGHT_DECAY="10"
    MFVI_WEIGHT_DECAY="5"
    COMMON_HYPERPARAMS="--dataset_name=$DATASET --model_name=$MODEL --subset_train_to=40960 --sequential_training --num_sequential_training_folds=2"
    SGD_WEIGHT_DECAY_DISPLAY="10.0"
    SGD_HYPERPARAMS="$COMMON_HYPERPARAMS --init_step_size=3e-7 --num_epochs=500 --eval_freq=10 --batch_size=80 --save_freq=100"
    VI_HYPERPARAMS="$COMMON_HYPERPARAMS --init_step_size=1e-4 --num_epochs=300 --eval_freq=10 --batch_size=80 --save_freq=150 --optimizer=Adam --vi_sigma_init=0.01 --temperature=1. --vi_ensemble_size=50"
    SGD_STEP_DISPLAY="3e-07"
elif [[ "$arg" == "cifar100" ]]; then
    DATASET="cifar100"
    MODEL="resnet20_frn_swish"
    SGD_WEIGHT_DECAY="10"
    MFVI_WEIGHT_DECAY="5"
    COMMON_HYPERPARAMS="--dataset_name=$DATASET --model_name=$MODEL --subset_train_to=40960 --sequential_training --num_sequential_training_folds=2"
    SGD_WEIGHT_DECAY_DISPLAY="10.0"
    SGD_HYPERPARAMS="$COMMON_HYPERPARAMS --init_step_size=1e-6 --num_epochs=500 --eval_freq=10 --batch_size=80 --save_freq=100"
    VI_HYPERPARAMS="$COMMON_HYPERPARAMS --init_step_size=1e-4 --num_epochs=300 --eval_freq=10 --batch_size=80 --save_freq=150 --optimizer=Adam --vi_sigma_init=0.01 --temperature=1. --vi_ensemble_size=50"
    SGD_STEP_DISPLAY="1e-06"
elif [[ "$arg" == "imdb" ]]; then
    DATASET="imdb"
    MODEL="cnn_lstm"
    SGD_WEIGHT_DECAY="3."
    MFVI_WEIGHT_DECAY="5"
    COMMON_HYPERPARAMS="--dataset_name=$DATASET --model_name=$MODEL --sequential_training --num_sequential_training_folds=2"
    SGD_WEIGHT_DECAY_DISPLAY="3.0"
    SGD_HYPERPARAMS="$COMMON_HYPERPARAMS --init_step_size=3e-7 --num_epochs=500 --eval_freq=20 --batch_size=80 --save_freq=500"
    VI_HYPERPARAMS="$COMMON_HYPERPARAMS --init_step_size=1e-4 --num_epochs=300 --eval_freq=10 --batch_size=80 --save_freq=150 --optimizer=Adam --vi_sigma_init=0.01 --temperature=1. --vi_ensemble_size=50"
    SGD_STEP_DISPLAY="3e-07"
else
    echo "Please specify cifar10 or imdb"
    exit 1
fi

# Ensure a seed value is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <seed> [-pca]"
    exit 1
fi

SEED=$1
echo "Running on seed $SEED..."

STRATIFIED_ARGS=""
DIRSUFFIX=""
# Check for optional -pca argument
if [[ "$2" == "-pca" ]]; then
    STRATIFIED_ARGS="--stratified_folds=pca"
    DIRSUFFIX="_pca"
fi

EXPERIMENT_DIR="$HOME/Projects/bnn_seq_vi/bnn_hmc/.runs/seq_multiseed/$DATASET"
RUNWD="$HOME/Projects/bnn_seq_vi"
cd $RUNWD
source "$(conda info --base)/etc/profile.d/conda.sh"
conda activate /home/gabor/miniforge3/envs/bnn
# PYTHON=`which python`
# echo "Using python: $PYTHON"
export PYTHONPATH="$RUNWD/:$PYTHONPATH"

# Run SGD for the first half
echo "SGD 1/2..."
python bnn_hmc/run_sgd.py --seed=$SEED --weight_decay=$SGD_WEIGHT_DECAY $SGD_HYPERPARAMS --dir=$EXPERIMENT_DIR/sgd_1_of_2$DIRSUFFIX/ \
     --index_sequential_training_fold=0 $STRATIFIED_ARGS

# Run VI for the first half
echo "MFVI 1/2..."
python bnn_hmc/run_vi.py --seed=$SEED --weight_decay=$MFVI_WEIGHT_DECAY $VI_HYPERPARAMS --dir=$EXPERIMENT_DIR/mfvi_1_of_2$DIRSUFFIX/ \
    --mean_init_checkpoint=$EXPERIMENT_DIR/sgd_1_of_2$DIRSUFFIX/sgd_mom_0.9__lr_sch_i_${SGD_STEP_DISPLAY}___epochs_500_wd_${SGD_WEIGHT_DECAY_DISPLAY}_batchsize_80_temp_1.0__seed_$SEED/model_step_499.pt \
    --index_sequential_training_fold=0 $STRATIFIED_ARGS

# Run SGD for the second half
echo "SGD 2/2..."
python bnn_hmc/run_sgd.py --seed=$SEED --pretrained_prior_checkpoint=$EXPERIMENT_DIR/mfvi_1_of_2$DIRSUFFIX/mfvi_initsigma_0.01_meaninit__opt_adam__lr_sch_i_0.0001___epochs_300_wd_5.0_batchsize_80_temp_1.0__seed_$SEED/model_step_299.pt \
    $SGD_HYPERPARAMS --dir=$EXPERIMENT_DIR/sgd_2_of_2$DIRSUFFIX/ --index_sequential_training_fold=1 $STRATIFIED_ARGS

# Find the output file produced by SGD for the second half
SGD_DIR_2_OF_2=$(ls $EXPERIMENT_DIR/sgd_2_of_2$DIRSUFFIX 2>/dev/null | grep -E "^sgd_mom_0.9__lr_sch_i_${SGD_STEP_DISPLAY}___epochs_500_pretr_[a-z0-9]+_batchsize_80_temp_1.0__seed_$SEED$")

if [ -z "$SGD_DIR_2_OF_2" ]; then
    echo "Error: No SGD 2/2 runs were found with seed $SEED: $(ls $EXPERIMENT_DIR/sgd_2_of_2$DIRSUFFIX)"
    exit 1
fi

if [ $(echo "$SGD_DIR_2_OF_2" | wc -l) -gt 1 ]; then
    echo "Error: Multiple SGD 2/2 runs were found with seed $SEED:\n$SGD_DIR_2_OF_2"
    exit 2
fi

# Run VI for the second half with the initial file generated by SGD
echo "MFVI 2/2..."
python bnn_hmc/run_vi.py --seed=$SEED --pretrained_prior_checkpoint=$EXPERIMENT_DIR/mfvi_1_of_2$DIRSUFFIX/mfvi_initsigma_0.01_meaninit__opt_adam__lr_sch_i_0.0001___epochs_300_wd_5.0_batchsize_80_temp_1.0__seed_$SEED/model_step_299.pt \
    $VI_HYPERPARAMS --dir=$EXPERIMENT_DIR/mfvi_2_of_2$DIRSUFFIX/ --mean_init_checkpoint=$EXPERIMENT_DIR/sgd_2_of_2$DIRSUFFIX/$SGD_DIR_2_OF_2/model_step_499.pt \
    --index_sequential_training_fold=1 $STRATIFIED_ARGS

# Run "sequential" SGD
echo "Sequential SGD 2/2 from 1/2 init..."
python bnn_hmc/run_sgd.py --seed=$SEED --weight_decay=$SGD_WEIGHT_DECAY $SGD_HYPERPARAMS --dir=$EXPERIMENT_DIR/sgd_2_of_2${DIRSUFFIX}_from_split1_init/ \
    --init_checkpoint=$EXPERIMENT_DIR/sgd_1_of_2$DIRSUFFIX/sgd_mom_0.9__lr_sch_i_${SGD_STEP_DISPLAY}___epochs_500_wd_${SGD_WEIGHT_DECAY_DISPLAY}_batchsize_80_temp_1.0__seed_$SEED/model_step_499.pt \
    --index_sequential_training_fold=1 $STRATIFIED_ARGS

