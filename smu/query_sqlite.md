# query_sqlite

The command line tool for accessing the SMU databases is `query_sqlite.py`

The page describes how to use it, the various options, and gives examples.

If you have not followed [the installantion instructions and gotten
the data](../README.md), do that first.

The sections below decribe the flags you can provide.


## Input

* `--input_sqlite`
Specifies the sqlite file to read (either the complete or standard), e.g.
`--input_sqlite 20220128_complete.sqlite`


## Output

* `--output_format`
There are a variety of different output formats
    * `pbtxt`: Human and machine readable test format that directly corresponds to the dataset.proto
    * `atomic_input`: Generates the input files to go into the Atomic fortran programs for computing Atomic energies
    * `dat`:  Original .dat format generated by the FORTRAN code
    * sdf: There are three different options for SDF output controlling which geometries (initial and optimized) are included:  `sdf_opt`, `sdf_init`, `sdf_init_opt`.

* `--sdf_include_all_bond_topologies` By default, an SDF entry is created for every alternative bond topology for a conformer. Set this to False to only produce a single bond topology (the one we consider to be "best"

* `--output_path`
Where to write the output (uses stdout if not given)


## Selecting Conformers

The most straightforward way to get some conformers out is with
* `--random_fraction` where each record in the database is returned with this probability. Note that the entire database is read, so this can be quite slow.

During the build of the database, we add several indices for fast lookup. You can provide multiple options and you will get output for all of them.

* `--btids`: List of bond topology ids (e.g 85532). All conformers with this bond topology ID (including the detected bond topologies) are returned.

* `--cids`: List of conformer id (eg 85532001). Zero or one conformers will be returned for each cid.

* `--smiles`: List of SMILES strings (e.g. CC=O). All conformers with bond topologies represented by these SMILES (including the detected bond topologies) are returned. Note that these inputs will be recanonicalized using the same procedure we used to build the database so alternative SMILES that are the same bond topology will return the same set of results. Note that if aromatic smiles are given one of the kekulized forms will be chosen somewhat arbitrarily. However, because of our geometry detection, this should still return the set of conformers covering the other kekulized form.

* `–stoichiometries`: List of stoichiometries like (C6H6) to query. Case does not matter.


## Geometry Based Searching
To support geometric manipulations, a file generated from our pipeline with histograms of observed bond lengths is needed to provide the default bond length information. This file is called `20220128_bond_lengths.csv`

* `--bond_lengths_csv` : should be given the path of the above file.

* `--bond_lengths`
To support specified alternative bond length restrictions, you can specify lengths on the command line. This is a comma separated list of terms
    ```
    <atom1><bond char><atom2>:<mindist>-<maxdist>
    ```
    Where
    * `<atom1>`, `<atom2>`: are characters in “CNOF*” (not that hydrogen is not allowed as we always attached hydrogens to their nearest heavy atom. The order is irrelevant. ‘*’ means to match any of CNOF
    * `<bond_char>`: is one of “-”, “=”, “#”, “.”, “\~”. These are the bond specifiers in SMILES strings, with ‘\~’ meaning any bond.
    * `<mindist>`, `<maxdist>`: lengths in angstroms. Either of them can be left off. For mindist, this is equivalent to 0. For maxdist, we use a “right_tail_mass” with an exponential decay of the pdf (meaning that a small amount of probablity mass is given to all lengths to infinity)

    For example, these are all valid terms
    ```
    N-N:1.3-1.7
    N=O:1.3-1.5
    C#C:1.21212-1.3456
    C.O:2.0-9999
    N~N:1.3-1.9    (which means all NN bonds are between 1.3 and 1.9)
    ```

    Note that `--bond_lengths` will override any data for that pair in `--bond_lengths_csv`

    Implementation note of interest: `--bond_lengths_csv` creates a EmpiricalLengthDistribution for each atom type pair. `--bond_lengths` creates a FixedWindowLengthDistribution for each given pair to replace the EmpiricalLengthDistribution

* `--bond_topology_csv` The CSV file `bond_topology.csv` provided in the download mapping topologies to a bond topology id. Must be provided to do geometry based searches.

* `--topology_query_smiles` To do a geometry based search, you then provide a comma separated list of SMILES strings specifying the geometry to search. Note that if `--bond_lengths` are not given, this will return the same conformers as `--smiles`.

### How does this work internally?
Each conformer is associated with a hydrogen specific stoichiometry. That is, the number of hydrogens bonded to a heavy atom is part of the atom type. So a carbon with no hydrogens is “c” but with two hydrogen is “ch2”. Examples:
* benzene: (ch)6
* water: (oh2)   (note that the 1 is implicit)
* ethylene: (ch2)2
* acrylic acid: (c)(ch)(ch2)(o)(oh)

In order for a conformer to match a query geometry, the hydrogen specific stoichiometry must match. So we locate all the conformers with matching hydrogen specific stoichiometry. For each one, we run the geometry detection algorithm (with the modified bond lengths from `--bond_lengths`). If one of the detected bond topologies is the same as the original geometry given in `--topology_query_smiles`, then the conformer is returned.

Note that this is not an especially efficient algorithm, but it’s able to reuse exactly the same geometry detection code so that we ensure everything is consistent.


## Redetecting Bond Topologies

Similar to the [geometry based searching](#geometry-based-searching), you can use the modification of allowed bond lengths (via the `--bond_lengths_csv` and `--bond_lengths` arguments) to perform topology sensing on any conformer returned (i.e. from the options in [Simple Indexed Selection](#simple-indexed-selection) )

* `--redetect_topology` Just specify this flag (in addition to `--bond_lengths_csv`, `--bond_lengths`, `--bond_topology_csv`


## Examples
Find the record for a specific conformer id.
```
python -m smu.query_sqlite \
--input_sqlite 20220128_complete.sqlite \
--cids 85485001 \
--output_format sdf_opt
```

Find the records for a bunch of conformer ids and send the output to a file
```
python -m smu.query_sqlite \
--input_sqlite 20220128_complete.sqlite \
--cids 1001,4001,1193001,81680048,91856010,102959011,102959027,108993002,200252001,405360002,899649001,899650001,899651001,899652001  \
--output_path /tmp/example.pbtxt
```

Find all the conformers for the given bond topology ids. Note that this searches by all detected topologies, not just the topology that originally created the conformer.
```
python -m smu.query_sqlite \
--input_sqlite 20220128_complete.sqlite \
--btids '581948,532611,532626,540263'
```

Find all the conformers corresponding to a given SMILES and output to sdf. Note that this internally canonicalizes the SMILES so that both the forms given here return the same thing.
```
python -m smu.query_sqlite \
--input_sqlite 20220128_complete.sqlite \
--smiles 'NN=O' \
--output_format sdf_opt \
--output_path /tmp/NNO_v0.sdf

python -m smu.query_sqlite \
--input_sqlite 20220128_complete.sqlite \
--smiles 'O=NN' \
--output_format sdf_opt \
--output_path /tmp/NNO_v1.sdf
```

A geometry based query. A SMILES string is given to define the topology, but the valid length of all NN bonds is set to less than 2A.
```
python -m smu.query_sqlite \
--input_sqlite 20220128_complete.sqlite \
--output_format sdf_opt  \
--bond_topology_csv bond_topology.csv \
--bond_lengths_csv 20220128_bond_lengths.csv \
--topology_query_smiles 'O=[N+]=NNN([O-])F' \
--bond_lengths 'N~N:-2.0'
```

A query by stoichiometry where we only return one bond topology for each conformer.
```
python -m smu.query_sqlite \
--input_sqlite 20220128_standard.sqlite \
--stoichiometries c6h14 \
--output_format sdf_opt \
--sdf_include_all_bond_topologies=False \
--output_path /tmp/c6h14.sdf
```