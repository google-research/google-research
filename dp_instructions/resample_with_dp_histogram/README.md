# Resampling Initial Synthetic Instructions

Main components:

1. ```get_instructions_from_generations.py```, load the text files generated by parallel 1 GPU jobs, and merge them into a .pkl file (contains a python list, each entry is a string instruction).
2. ```get_embeddings.py```, compute the Sentence-T5 embeddings for a given .pkl file.
3. ```resample_with_embeddings.py```, take the .pkl file and the embeddings file, and then run UnitedSignal to filter the instructions.

## Mergeing Outputs from Parallel Processes into A .pkl File [Optional]


This is step is optional. You can prepare your own .pkl file, as long as the file contains a python list of string instructions.

We use parallel 1 GPU processes to generate synthetic instructions. Using the code in ```dp_finetuning```, each process will generate a text file. This script will merge all the text files into a python list of strings, and save it to a .pkl file. Example command:
```
python get_instructions_from_generations.py --generation_folder [path to the folder, by default is inference_outputs/[job_sess]] --output_file [path to the output .pkl file]
```

## Compute Sentence-T5 Embeddings for Synthetic/Real Instructions

The script downloads the Sentence-T5 model automatically. Example command:
```
python get_embeddings.py --instruction_file [path to the .pkl file] --output_file [path to the output embedding .npy file] --num_targets 1000000
```

## Resample Instructions using a DP Histogram

Example command:
```
python resample_with_embeddings.py --real_embeddings_path [path to a .npy file] --syn_embeddings_path [path to a .npy file] --syn_instructions_path [path to a .pkl file] --output_name [a string] --num_buckets 1000 --histogram_sigma 10
```

